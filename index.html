<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Fahrzeiten-Rechner Baden-Württemberg</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
}

/* Wrapper für Controls + Info */
#controls-wrapper {
    position: relative;
}

/* Controls */
#controls {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    padding: 10px;
    background: #f0f0f0;
    align-items: flex-start;
    z-index: 1000;
}

.control-group {
    position: relative;
    flex: 1 1 200px;
}

#controls input[type="text"],
#controls input[type="number"] {
    width: 100%;
    padding: 6px 10px;
    border-radius: 8px;
    box-sizing: border-box;
    border: 1px solid #ccc;
    outline: none;
    box-shadow: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
}

#controls button {
    padding: 6px 12px;
    border-radius: 8px;
    background: #7cff9f;
    border: none;
    cursor: pointer;
    flex: 1 1 120px;
}

.suggestions {
    position: absolute;
    top: 38px;
    left: 0;
    width: 100%;
    background: #fff;
    border: 1px solid #ccc;
    max-height: 150px;
    overflow-y: auto;
    z-index: 10000;
}

.suggestions div {
    padding: 5px;
    cursor: pointer;
}

.suggestions div:hover {
    background: #eee;
}

#map {
    height: calc(100vh - 100px);
    width: 100%;
    border-radius: 0;
}

#time {
    width: 100%;
    font-weight: bold;
    margin-top: 5px;
}

/* Versionszeile Desktop oben rechts */
.info {
    font-size: 0.9em;
    position: absolute;
    top: 10px;
    right: 10px;
    margin-top: 30px;
}

/* Links ohne Unterstreichung */
.link {
    text-decoration: none;
}

/* --- Mobilversion --- */
@media (max-width: 800px) {
    #controls {
        flex-direction: column;
        align-items: stretch;
        gap: 4px;
        padding: 6px;
    }

    .control-group {
        flex: 1 1 100%;
    }

    #controls input[type="text"],
    #controls input[type="number"] {
        padding: 4px 6px;
    }

    #controls button {
        flex: 1 1 100%;
        padding: 5px 8px;
    }

    .suggestions {
        top: 32px;
        max-height: 120px;
    }

    /* Versionszeile unter Controls zentriert */
    .info {
        position: static;
        text-align: center;
        margin-top: 4px;
    }
}
</style>
</head>
<body>
<div id="controls-wrapper">
    <div id="controls">
        <div class="control-group">
            <input type="text" id="start" placeholder="Startbahnhof">
            <div id="suggestions-start" class="suggestions"></div>
        </div>
        <div class="control-group">
            <input type="text" id="end" placeholder="Zielbahnhof">
            <div id="suggestions-end" class="suggestions"></div>
        </div>
        <div class="control-group">
            <input type="number" id="maxV" placeholder="Max. Geschwindigkeit (km/h)" value="120" min="10">
        </div>
        <button id="routeBtn">Route berechnen</button>
        <span id="time"></span>
    </div>

    <!-- Versionszeile außerhalb der Controls -->
    <h3 class="info">Entwickelt von <a class="link" href="https://flowwebdesign.de">FlowWebDesign</a> v0.1beta</h3>
</div>

<div id="map"></div>

<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// --- Variablen ---
let nodes = [], edges = [], graph = {};
let map = L.map('map').setView([48.78, 9.18], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let routeLayer = null;

// --- JSON laden ---
fetch('bw_rail_vmax.json')
  .then(res=>res.json())
  .then(data=>{nodes=data.stations; edges=data.edges; buildGraph(); initAutocomplete();});

// --- Graph aufbauen ---
function buildGraph(){
    graph={};
    nodes.forEach(n=>graph[n.id]=[]);
    edges.forEach(e=>{
        graph[e.from].push({to:e.to,distance:e.distance,vmax:e.vmax});
        graph[e.to].push({to:e.from,distance:e.distance,vmax:e.vmax});
    });
}

// --- Dijkstra: Fahrzeit pro Segment mit User-Vmax ---
function dijkstra(graph,startId,endId,userVmax){
    const dist={}, prev={}, pq=[];
    for(const id in graph) dist[id]=Infinity;
    dist[startId]=0; pq.push({id:startId,dist:0});
    while(pq.length>0){
        pq.sort((a,b)=>a.dist-b.dist);
        const {id:u}=pq.shift();
        if(u==endId) break;
        graph[u].forEach(e=>{
            const speed=Math.min(e.vmax,userVmax);
            const alt=dist[u]+e.distance/speed;
            if(alt<dist[e.to]){dist[e.to]=alt; prev[e.to]=u; pq.push({id:e.to,dist:alt});}
        });
    }
    const path=[]; let u=endId;
    while(u!==undefined){path.unshift(u); u=prev[u];}
    return path;
}

// --- Autocomplete ---
function initAutocomplete(){
    function autocomplete(input,suggDiv){
        input.addEventListener("input",()=>{
            const val=input.value.toLowerCase();
            suggDiv.innerHTML="";
            if(!val) return;
            const matches=nodes.filter(s=>s.name && s.name.toLowerCase().includes(val)).slice(0,10);
            matches.forEach(s=>{
                const div=document.createElement("div");
                div.textContent=s.name;
                div.onclick=()=>{input.value=s.name;suggDiv.innerHTML="";};
                suggDiv.appendChild(div);
            });
        });
    }
    autocomplete(document.getElementById("start"),document.getElementById("suggestions-start"));
    autocomplete(document.getElementById("end"),document.getElementById("suggestions-end"));
}

// --- Route berechnen ---
document.getElementById("routeBtn").onclick=()=>{
    const startName=document.getElementById("start").value;
    const endName=document.getElementById("end").value;
    const userVmax=Number(document.getElementById("maxV").value)||120;
    const start=nodes.find(n=>n.name==startName&&n.name);
    const end=nodes.find(n=>n.name==endName&&n.name);
    if(!start||!end){alert("Bitte gültigen Bahnhof eintragen"); return;}
    const path=dijkstra(graph,start.id,end.id,userVmax);
    if(path.length<2){alert("Keine Route gefunden!"); return;}
    drawRoute(path,userVmax);
}

// --- Route zeichnen ---
function drawRoute(path,userVmax){
    if(routeLayer) map.removeLayer(routeLayer);
    const latlngs=[]; let totalMinutes=0;
    for(let i=0;i<path.length-1;i++){
        const from=path[i]; const to=path[i+1];
        const edge=graph[from].find(e=>e.to===to);
        if(edge){
            const nFrom=nodes.find(n=>n.id==from); latlngs.push([nFrom.lat,nFrom.lon]);
            const speed=Math.min(edge.vmax,userVmax);
            totalMinutes+=(edge.distance/speed)*60;
        }
    }
    const lastNode=nodes.find(n=>n.id==path[path.length-1]); latlngs.push([lastNode.lat,lastNode.lon]);
    routeLayer=L.polyline(latlngs,{color:'blue'}).addTo(map);
    map.fitBounds(routeLayer.getBounds());
    document.getElementById("time").textContent=" Fahrzeit ca. "+formatTime(totalMinutes);
}

function formatTime(minutes){
    if(minutes<=60) return Math.round(minutes)+" min";
    const h=Math.floor(minutes/60); const m=Math.round(minutes%60);
    return h+":"+(m<10?"0":"")+m+" h";
}
</script>
</body>
</html>

